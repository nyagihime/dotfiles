#!/bin/sh
cd `tmux display-message -p -F "#{pane_current_path}"`
branch_name=`git branch | grep \*.* | sed -e 's/\*\ //'`
user_name=`git config --get user.name`
email_address=`git config --get user.email`

# ユーザー名、メールアドレスが一定文字以上ならトリムする
if test ${#user_name} -gt 4; then
  user_name=${user_name::4}..
fi

if test ${#email_address} -gt 3; then
  email_address=${email_address::3}..
fi

if [ $1 = "--name-only" ]; then
  vcs_usr=" ${user_name}"
elif [ $1 = "--mail-only" ]; then
  vcs_usr="${email_address}"
else
  vcs_usr="${user_name}[${email_address}]"
fi

if [ ! -z ${branch_name} ]; then

  # ブランチ名で色分け（とりあえずよく使う master / develop は専用カラーをあててみた）
  # TODO: remote と同期してるかとか、modified があるかとかでも色分けしたい

  # ブランチ名が一定以上の長さなら詰める
  if test ${#branch_name} -gt 3; then
      branch_disp=${branch_name::3}..
  else
      branch_disp=${branch_name}
  fi

  case ${branch_name} in
    "master" ) display_branch_name="#[fg=red]${branch_disp}";;
    "develop" ) display_branch_name="#[fg=green]${branch_disp}";;
    * )
    display_branch_name="#[fg=colour75]${branch_disp}";;
  esac

  echo "#[bg=colour240 fg=colour236] "\
       "#[fg=yellow] :${display_branch_name}"\
       "#[fg=yellow] :${vcs_usr}"\
       "#[default]"
else
  echo "#[bg=colour240 fg=colour232] "\
       "#[fg=colour245] "\
       "#[default]"
fi
